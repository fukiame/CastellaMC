From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: KurumiFake <kurumiisshidowife@gmail.com>
Date: Thu, 30 Jun 2022 00:46:56 +0700
Subject: [PATCH] move Airplane config to yaml

theres nothing bad with AIR nessecarily saying, its just kinda annoying having multiple file formats to deal with

diff --git a/pom.xml b/pom.xml
index c240b158c2db16d65d45c07a84bd45a7b6256017..d783cb71611016712c86a523a600a6cb9abb8d41 100644
--- a/pom.xml
+++ b/pom.xml
@@ -207,13 +207,6 @@
                 </exclusion>
             </exclusions>
         </dependency>
-        <!-- Airplane Config -->
-        <dependency>
-            <groupId>com.github.technove</groupId>
-            <artifactId>AIR</artifactId>
-            <version>fe3dbb4420</version>
-            <scope>compile</scope>
-        </dependency>
     </dependencies>
 
     <!-- This builds a completely 'ready to start' jar with all dependencies inside -->
diff --git a/src/main/java/gg/airplane/AirplaneCommand.java b/src/main/java/gg/airplane/AirplaneCommand.java
index 89c89e633f14b5820147e734b1b7ad8cadfdce80..a940c8590e1612473948d6d4dc3a574667952505 100644
--- a/src/main/java/gg/airplane/AirplaneCommand.java
+++ b/src/main/java/gg/airplane/AirplaneCommand.java
@@ -46,6 +46,8 @@ public class AirplaneCommand extends Command {
 
         if (args[0].equalsIgnoreCase("reload")) {
             MinecraftServer console = MinecraftServer.getServer();
+            // Lazinity start - migrate to yaml
+            /*
             try {
                 AirplaneConfig.load();
             } catch (IOException e) {
@@ -53,6 +55,9 @@ public class AirplaneCommand extends Command {
                 e.printStackTrace();
                 return true;
             }
+            */
+            AirplaneConfig.init((java.io.File) console.options.valueOf("airplane-settings"));
+            // Lazinity end
             console.server.reloadCount++;
 
             Command.broadcastCommandMessage(sender, prefix + "Airplane configuration has been reloaded.");
diff --git a/src/main/java/gg/airplane/AirplaneConfig.java b/src/main/java/gg/airplane/AirplaneConfig.java
index 3a8a494d2f4f5a2d1f35328be082e2c4379e1474..21c1b16221d34b2414e281d8aa14c9c4cd3404a1 100644
--- a/src/main/java/gg/airplane/AirplaneConfig.java
+++ b/src/main/java/gg/airplane/AirplaneConfig.java
@@ -1,107 +1,113 @@
-package gg.airplane;
-
-import co.technove.air.AIR;
-import net.minecraft.server.MinecraftServer;
-import org.apache.logging.log4j.Level;
-
-import java.io.File;
-import java.io.FileInputStream;
-import java.io.FileOutputStream;
-import java.io.IOException;
-import java.lang.reflect.Method;
-import java.lang.reflect.Modifier;
-
-public class AirplaneConfig {
-
-    private static AIR config;
-
-    public static void load() throws IOException {
-        File configFile = new File("airplane.air");
-        if (configFile.exists()) {
-            try (FileInputStream inputStream = new FileInputStream(configFile)) {
-                config = new AIR(inputStream);
-            }
-        } else {
-            config = new AIR();
-        }
-
-        config.setComment("info",
-          "Airplane Configuration",
-          "Read https://blog.airplane.gg/ to find out more about Airplane",
-          "Join our Discord to receive support & optimization help: https://discord.gg/3gtc45q");
-        config.getString("info.version", "1.0");
-
-        for (Method method : AirplaneConfig.class.getDeclaredMethods()) {
-            if (Modifier.isStatic(method.getModifiers()) && Modifier.isPrivate(method.getModifiers())) {
-                method.setAccessible(true);
-                try {
-                    method.invoke(null);
-                } catch (Throwable t) {
-                    MinecraftServer.LOGGER.log(Level.WARN, "Failed to load configuration option from " + method.getName(), t);
-                }
-            }
-        }
-
-        try (FileOutputStream outputStream = new FileOutputStream(configFile)) {
-            config.save(outputStream);
-        }
-    }
-
-    public static boolean dearEnabled;
-    public static int startDistance;
-    public static int startDistanceSquared;
-    public static int maximumActivationPrio;
-    public static int activationDistanceMod;
-    public static boolean dynamicVillagerBehavior;
-    public static boolean dynamicPiglinBehavior;
-    public static boolean dynamicHoglinBehavior;
-
-    private static void dynamicActivationRange() {
-        config.setComment("activation-range", "Optimizes how entities act when", "they're far away from the player");
-
-        dearEnabled = config.getBoolean("activation-range.enabled", true);
-        startDistance = config.getInt("activation-range.start-distance", 12,
-          "This value determines how far away an entity has to be",
-          "from the player to start being effected by DEAR.");
-        startDistanceSquared = startDistance * startDistance;
-        maximumActivationPrio = config.getInt("activation-range.max-tick-freq", 20,
-          "This value defines how often in ticks, the furthest entity",
-          "will get their pathfinders and behaviors ticked. 20 = 1s");
-        activationDistanceMod = config.getInt("activation-range.activation-dist-mod", 8,
-          "This value defines how much distance modifies an entity's",
-          "tick frequency. freq = (distanceToPlayer^2) / (2^value)",
-          "If you want further away entities to tick less often, use 7.",
-          "If you want further away entities to tick more often, try 9.");
-
-        config.setComment("behavior-activation", "A list of entities to use the dynamic activation range", "to modify how often their behaviors are ticked");
-
-        dynamicVillagerBehavior = config.getBoolean("behavior-activation.villager", true);
-        dynamicPiglinBehavior = config.getBoolean("behavior-activation.piglin", true);
-        dynamicHoglinBehavior = config.getBoolean("behavior-activation.hoglin", true);
-    }
-
-
-    public static byte entityDespawnCheckFrequency;
-
-    private static void entitySettings() {
-        config.setComment("entities", "Configures settings for generic entities");
-
-        entityDespawnCheckFrequency = (byte) Math.max(config.getInt("entities.despawn-check-freq", 8), Byte.MAX_VALUE);
-    }
-
-
-    public static boolean disableMethodProfiler;
-    public static boolean simplerItemCollision;
-
-    private static void miscSettings() {
-        config.setComment("misc", "Settings for things that don't belong elsewhere");
-
-        disableMethodProfiler = config.getBoolean("misc.disable-method-profiler", true);
-        simplerItemCollision = config.getBoolean("misc.simpler-item-collision", false,
-          "When an item is inside a block, it gets pushed up.",
-          "This option when true makes the check simpler,",
-          "ignoring entities and complex collisions like pistons.");
-    }
-
-
-}
+package gg.airplane;
+
+import org.bukkit.Bukkit;
+import org.bukkit.configuration.file.YamlConfiguration;
+
+import net.minecraft.server.MinecraftServer;
+
+import java.io.File;
+import java.lang.reflect.Method;
+import java.lang.reflect.Modifier;
+import java.util.logging.Level;
+
+public final class AirplaneConfig {
+
+    public static final int CURRENT_CONFIG_VERSION = 0;
+
+    private static final Object[] EMPTY = new Object[0];
+
+    private static File configFile;
+    private static YamlConfiguration config;
+    private static int configVersion;
+
+    public static void init(final File file) {
+        AirplaneConfig.configFile = file;
+        AirplaneConfig.config = new YamlConfiguration();l
+        config.options().copyDefaults(true);
+
+        if (!file.exists()) {
+            try {
+                file.createNewFile();
+            } catch (final Exception ex) {
+                System.out.println("Failure to create Airplane config");
+                ex.printStackTrace();
+            }
+        } else {
+            try {
+                config.load(file);
+            } catch (final Exception ex) {
+                System.out.println("Failure to load Airplane config");
+                throw new RuntimeException(ex);
+            }
+        }
+
+        AirplaneConfig.load(AirplaneConfig.class, null);
+    }
+
+    public static void load(Class<?> clazz, Object instance) {
+        AirplaneConfig.configVersion = AirplaneConfig.getInt("config-version-please-do-not-modify-me", CURRENT_CONFIG_VERSION);
+
+        for (final Method method : clazz.getDeclaredMethods()) {
+            if (method.getReturnType() != void.class || method.getParameterCount() != 0 ||
+                    !Modifier.isPrivate(method.getModifiers()) || (instance == null && !Modifier.isStatic(method.getModifiers()))) {
+                continue;
+            }
+
+            try {
+                method.setAccessible(true);
+                method.invoke(instance, EMPTY);
+            } catch (final Exception ex) {
+                throw new RuntimeException(ex);
+            }
+        }
+
+        /* We re-save to add new options */
+        try {
+            config.save(AirplaneConfig.configFile);
+        } catch (final Exception ex) {
+            System.out.println("Unable to save Airplane config");
+            ex.printStackTrace();
+        }
+    }
+
+    private static boolean getBoolean(final String path, final boolean dfl) {
+        AirplaneConfig.config.addDefault(path, Boolean.valueOf(dfl));
+        return AirplaneConfig.config.getBoolean(path, dfl);
+    }
+
+    private static int getInt(final String path, final int dfl) {
+        AirplaneConfig.config.addDefault(path, Integer.valueOf(dfl));
+        return AirplaneConfig.config.getInt(path, dfl);
+    }
+
+    public static boolean dearEnabled;
+    public static int startDistance;
+    public static int startDistanceSquared;
+    public static int maximumActivationPrio;
+    public static int activationDistanceMod;
+    public static boolean dynamicVillagerBehavior;
+    public static boolean dynamicPiglinBehavior;
+    public static boolean dynamicHoglinBehavior;
+    private static void dynamicActivationRange() {
+        dearEnabled = getBoolean("activation-range.enabled", true);
+        startDistance = getInt("activation-range.start-distance", 12);
+        startDistanceSquared = startDistance * startDistance;
+        maximumActivationPrio = getInt("activation-range.max-tick-freq", 20);
+        activationDistanceMod = getInt("activation-range.activation-dist-mod", 8);
+        dynamicVillagerBehavior = getBoolean("behavior-activation.villager", true);
+        dynamicPiglinBehavior = getBoolean("behavior-activation.piglin", true);
+        dynamicHoglinBehavior = getBoolean("behavior-activation.hoglin", true);
+    }
+
+    public static byte entityDespawnCheckFrequency;
+    private static void entitySettings() {
+        entityDespawnCheckFrequency = (byte) Math.max(config.getInt("entities.despawn-check-freq", 8), Byte.MAX_VALUE);
+    }
+
+    public static boolean disableMethodProfiler;
+    public static boolean simplerItemCollision;
+    private static void miscSettings() {
+        disableMethodProfiler = config.getBoolean("misc.disable-method-profiler", true);
+        simplerItemCollision = config.getBoolean("misc.simpler-item-collision", false);
+    }
+}
diff --git a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
index 5836c44bbd019a7eeaad875eddad9b953f4d6c92..6c93f2d6ab6755898f7fe828bbc863dd1efa7194 100644
--- a/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
+++ b/src/main/java/net/minecraft/server/dedicated/DedicatedServer.java
@@ -216,7 +216,8 @@ public class DedicatedServer extends MinecraftServer implements IMinecraftServer
         io.papermc.paper.brigadier.PaperBrigadierProviderImpl.INSTANCE.getClass(); // init PaperBrigadierProvider
         // Paper end
         com.tuinity.tuinity.config.TuinityConfig.init((java.io.File) options.valueOf("tuinity-settings")); // Tuinity - Server Config
-        gg.airplane.AirplaneConfig.load(); // Airplane - config
+        //gg.airplane.AirplaneConfig.load(); // Airplane - config // Lazinity
+        gg.airplane.AirplaneConfig.init((java.io.File) options.valueOf("airplane-settings")); // Airplane - config // Lazinity - migrate to yaml
         gg.airplane.commands.AirplaneCommands.init(); // Airplane - command
 
         this.setPVP(dedicatedserverproperties.pvp);
